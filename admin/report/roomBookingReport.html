<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Room Admin - Reservation Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- JS Scripts -->
    <script src="../../style/js/config.js"></script>
    <script src="../../style/js/header.js"></script>
    <script src="../../style/js/plugin.js"></script>
    <script src="../../style/js/bootstrap-datepicker.min.js"></script>
    <script src="../../style/js/clockpicker.js"></script>
    <script src="../../style/js/custom.js"></script>
    <script src="/sessionstorage.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../../style/css/styles.css" />
    <style>
      .button {
        background-color: #008cba;
        border: none;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 6px;
      }
      .table_wrapper {
        overflow-x: auto;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="container">
        <div class="logout">
          <a href="javascript:void(0);" onclick="history.back()">Back</a>
          &nbsp; | &nbsp; <a href="/admin/">Home</a> &nbsp; | &nbsp;
          <a id="homelink" href="/admin/">Logout</a>
        </div>
      </div>
    </div>

    <div class="middlecontent">
      <div class="container">
        <div class="whitesec">
          <div class="inner-padding">
            <div class="frm-head">
              <h1 class="text-center">
                Room Reservation Report
                <br />
                <small>
                  From
                  <span style="color: blue">
                    <?php echo htmlspecialchars(date('d/m/Y', strtotime($checkin1))); ?>
                  </span>
                  to
                  <span style="color: blue">
                    <?php echo htmlspecialchars(date('d/m/Y', strtotime($checkin2))); ?>
                  </span>
                </small>
              </h1>
            </div>

            <div class="form">
              <div class="table_wrapper">
                <table class="table table-striped table-bordered text-center">
                  <thead>
                    <tr>
                      <th>Sr. #</th>
                      <th>Room Type</th>
                      <th>Guest Name</th>
                      <th>Mobile</th>
                      <th>Centre</th>
                      <th>Room No.</th>
                      <th>Check-In</th>
                      <th>Check-Out</th>
                      <th>Nights</th>
                      <th>Change</th>
                      <th>Cancel</th>
                    </tr>
                  </thead>
                  <tbody>
                    <?php
                      $query = "SELECT *, DATEDIFF(checkout, checkin) AS totalnights, 
                                (@a:=@a+1) AS serial_number 
                                FROM guest_stay, (SELECT @a:= 0) AS a 
                                WHERE checkin BETWEEN '$checkin1' AND '$checkin2' 
                                AND roomno != 'WL' 
                                ORDER BY checkin, roomno ASC";

                      $result = mysqli_query($conn, $query) or die("Failed: " . mysqli_error($conn));

                      if (mysqli_num_rows($result) > 0):
                        while ($row = mysqli_fetch_assoc($result)):
                          $qtbookingid = $row['bookingid'];
                          $cardno = $row['cardno'];

                          $resultqt = mysqli_query($conn, "SELECT * FROM qtroom_booking WHERE bookingid = $qtbookingid");
                          $rowqt = mysqli_fetch_assoc($resultqt) ?? [];

                          $resultphno = mysqli_query($conn, "SELECT * FROM card_db WHERE cardno = $cardno");
                          $rowphno = mysqli_fetch_assoc($resultphno) ?? [];
                    ?>
                    <tr>
                      <td><?php echo $row['serial_number']; ?></td>
                      <td><?php echo $row['roomtype']; ?></td>
                      <td><?php echo $row['guest_name']; ?></td>
                      <td><?php echo $rowphno['mobno']; ?></td>
                      <td><?php echo $row['centre']; ?></td>
                      <td><?php echo $row['roomno']; ?></td>
                      <td><?php echo date('d/m/Y', strtotime($row['checkin'])); ?></td>
                      <td><?php echo date('d/m/Y', strtotime($row['checkout'])); ?></td>
                      <td><?php echo $row['totalnights']; ?></td>
                      <td>
                        <a href="assign_room.php?bookingid=<?php echo $row['bookingid']; ?>" target="_blank">
                          Stay Bed No.
                        </a>
                      </td>
                      <td>
                        <a href="manual_cancel.php?bookingid=<?php echo $row['bookingid']; ?>" target="_blank">
                          Cancel Booking
                        </a>
                      </td>
                    </tr>
                    <?php endwhile; else: ?>
                    <tr>
                      <td colspan="11">No reservations found.</td>
                    </tr>
                    <?php endif; ?>
                  </tbody>
                </table>
              </div>

              <!-- Export Button -->
              <div class="text-center mt-4">
                <button
                  class="button"
                  onclick="window.location.href='generate_room_booking_data.php?export=true&checkin1=<?php echo urlencode($checkin1); ?>&checkin2=<?php echo urlencode($checkin2); ?>'"
                >
                  Export to Excel
                </button>
              </div>
            </div> <!-- .form -->
          </div> <!-- .inner-padding -->
        </div> <!-- .whitesec -->
      </div> <!-- .container -->
    </div> <!-- .middlecontent -->
  </body>
</html>
